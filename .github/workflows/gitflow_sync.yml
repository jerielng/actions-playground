name: Sync main to develop

on:
  push:
    branches:
      - main

jobs:
  sync-main-to-develop:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set email and name for Git config
      run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "actions@github.com"

    - name: Attempt to merge main into develop
      run: |
        git fetch --unshallow
        git checkout develop
        git pull
        git merge --no-ff main
        git push

    - name: Create pull request if merge failed
      if: ${{ failure() }}
      run: |
        echo "Encountered some issues when trying to merge main into develop."
        gh pr create -B main -H develop --title 'Merge `main` back into `develop`' --body 'Generated by GitHub Actions due to auto-merge issues. Please review the pull request for more details. Then create a new `main` vs `develop` after merging.'
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create new main vs develop if merge succeeded
      if: ${{ success() }}
      run: |
        git fetch --unshallow
        git checkout develop
        git pull
        git commit -m "Placeholder for MvD" --allow-empty
        git push
        gh pr create -B develop -H main --title '[Do Not Merge] `main` vs `develop`' --body '### Placeholder'
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
